<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat IA</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      border-radius: 0 0 16px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      overflow: hidden;
    }
    .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 1rem;
      word-break: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .msg img.chat-img {
      display: block;
      max-width: 220px;
      max-height: 180px;
      width: auto;
      height: auto;
      border-radius: 10px;
      margin-top: 6px;
      margin-bottom: 2px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.10);
    }
    .msg.user {
      align-self: flex-end;
      background: #d1e7ff;
      color: #1a237e;
    }
    .msg.bot {
      align-self: flex-start;
      background: #e8eaf6;
      color: #333;
    }
    .input-area {
      display: flex;
      padding: 12px;
      background: #fafafa;
      border-top: 1px solid #eee;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 1rem;
      outline: none;
    }
    .input-area button {
      margin-left: 8px;
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      background: #1976d2;
      color: #fff;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .input-area button:active {
      background: #1565c0;
    }
    .input-area button:disabled {
      background: #bdbdbd;
      color: #eee;
      cursor: not-allowed;
      opacity: 1;
    }
  .typing-dots {
    display: inline-block;
    margin-left: 2px;
  }
  .typing-dots span {
    opacity: 0.2;
    animation: blink 1.2s infinite;
    font-weight: bold;
    font-size: 1.2em;
    margin-left: 1px;
  }
  .typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
  }
  .typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
  }
  @keyframes blink {
    0%, 80%, 100% { opacity: 0.2; }
    40% { opacity: 1; }
  }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div id="verificaOnline" style="display:none;max-width:480px;margin:40px auto 0 auto;padding:32px 24px;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.07);text-align:center;">
    <h2 style="color:#1976d2;margin-bottom:16px;">Chat ocupado</h2>
    <p style="font-size:1.1em;">Já existe um usuário mexendo no chatbot neste momento.<br>Tente novamente em instantes.</p>
  </div>
  <div class="chat-container" id="chatContainer" style="display:none;">
    <div class="messages" id="messages"></div>
    <form class="input-area" id="chatForm" autocomplete="off">
      <input type="text" id="msgInput" placeholder="Digite sua mensagem..." required />
      <button type="submit">Enviar</button>
    </form>
  </div>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      // Configuração do Supabase
      const supabaseUrl = 'https://xhybbhdhjaluqjrtopml.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoeWJiaGRoamFsdXFqcnRvcG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzQ5NjMsImV4cCI6MjA2ODg1MDk2M30.Xb98A6l-duDBO6G8_3SPKwluyAm-v8LH5G22ysmSXck';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      const verificaDiv = document.getElementById('verificaOnline');
      const chatContainer = document.getElementById('chatContainer');
      const messagesDiv = document.getElementById('messages');
      const chatForm = document.getElementById('chatForm');
      const msgInput = document.getElementById('msgInput');
      const sendBtn = chatForm.querySelector('button[type="submit"]');
      let aguardandoResposta = false;
      let sessionId = null;
      let heartbeatInterval = null;

      // Função para verificar se já existe usuário online usando apenas uma linha
      async function verificaOnline() {
        // Busca a linha única (id=uuid) da tabela chatbot_sessions
        const SESSION_UUID = '13b35ace-a1d0-4161-9f67-e43dca7c62a6';
        const { data, error } = await supabase
          .from('chatbot_sessions')
          .select('id, last_seen')
          .eq('id', SESSION_UUID)
          .single();
        const agora = new Date();
        let ocupado = false;
        if (data && data.last_seen) {
          const lastSeen = new Date(data.last_seen);
          ocupado = (agora - lastSeen) < 60000;
        }
        if (ocupado) {
          verificaDiv.style.display = '';
          return;
        }
        // Se não está ocupado, limpa a tabela conversas e insere mensagem padrão
        await supabase.from('conversas').delete().not('id', 'is', null); // deleta tudo
        // Tenta inserir mensagem padrão com todos os campos obrigatórios
        await supabase.from('conversas').insert([
          {
            pergunta: null,
            resposta: 'Bem vindo, como eu posso te ajudar hoje?',
            created_at: new Date().toISOString()
          }
        ]);
        chatContainer.style.display = '';
        iniciarHeartbeat();
        loadMessages();
      }

      // Função para enviar heartbeat a cada 30s (atualiza last_seen da linha única)
      function iniciarHeartbeat() {
        // Atualiza imediatamente ao liberar
        const SESSION_UUID = '13b35ace-a1d0-4161-9f67-e43dca7c62a6';
        supabase
          .from('chatbot_sessions')
          .update({ last_seen: new Date().toISOString() })
          .eq('id', SESSION_UUID);
        heartbeatInterval = setInterval(async () => {
          await supabase
            .from('chatbot_sessions')
            .update({ last_seen: new Date().toISOString() })
            .eq('id', SESSION_UUID);
        }, 30000);
      }

      verificaOnline();
      // Não remove mais a linha ao fechar a aba, apenas deixa de atualizar
      window.addEventListener('beforeunload', function() {
        if (heartbeatInterval) clearInterval(heartbeatInterval);
      });

      // Carregar mensagens do usuário
      async function loadMessages() {
        const { data, error } = await supabase
          .from('conversas')
          .select('id, pergunta, resposta, created_at')
          .order('created_at', { ascending: true });
        if (error) return;
        messagesDiv.innerHTML = '';
        let ultimaSemResposta = null;
        data.forEach(msg => {
          addMessage(msg.pergunta, 'user', msg.id);
          if (msg.resposta) {
            addMessage(msg.resposta, 'bot', msg.id);
          } else {
            // Só adiciona o balão de "Respondendo..." para a última mensagem sem resposta
            ultimaSemResposta = msg;
          }
        });
        // Se existe uma mensagem sem resposta, desabilita o botão
        aguardandoResposta = !!ultimaSemResposta;
        sendBtn.disabled = aguardandoResposta;
        // Adiciona o balão de "Respondendo..." com delay de 3 segundos apenas para a última mensagem sem resposta
        if (ultimaSemResposta) {
          setTimeout(() => {
            // Só adiciona se ainda não existe o balão
            if (!messagesDiv.querySelector('[data-msgid="wait_' + ultimaSemResposta.id + '"]')) {
              addMessage('Respondendo...', 'bot', 'wait_' + ultimaSemResposta.id);
            }
          }, 3000);
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Adicionar mensagem na tela
      function addMessage(text, who, msgid) {
        if (!text) return;
        const div = document.createElement('div');
        div.className = 'msg ' + who;
        if (msgid) div.dataset.msgid = msgid;
        if (text === 'Respondendo...') {
          div.innerHTML = 'Respondendo<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
        } else {
          // Detecta links de imagem (jpg, png, gif, webp, jpeg)
          const imgRegex = /(https?:\/\/(?:[\w.-]+)\.[a-z]{2,}(?:\/[\w\-.~:/?#[\]@!$&'()*+,;=]*)?\.(?:png|jpe?g|gif|webp))/gi;
          let html = text.replace(imgRegex, function(url) {
            return `<br><img src="${url}" class="chat-img" alt="imagem">`;
          });
          // Detecta links normais e transforma em <a>
          const urlRegex = /(https?:\/\/(?:[\w.-]+)\.[a-z]{2,}(?:\/[\w\-.~:/?#[\]@!$&'()*+,;=]*)?)/gi;
          html = html.replace(urlRegex, function(url) {
            // Não transformar links de imagem já convertidos
            if (/(png|jpe?g|gif|webp)$/i.test(url)) return url;
            return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
          });
          div.innerHTML = html;
        }
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Enviar mensagem
      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (aguardandoResposta) return;
        const text = msgInput.value.trim();
        if (!text) return;
        msgInput.value = '';
        sendBtn.disabled = true;
        aguardandoResposta = true;
        try {
          // Insere na tabela com resposta null e pega o id
          const { data, error } = await supabase
            .from('conversas')
            .insert([{ pergunta: text, resposta: null }])
            .select('id, created_at');
          if (data && data[0]) {
            // Adiciona a mensagem do usuário imediatamente
            addMessage(text, 'user', data[0].id);
            // Adiciona o balão de "Respondendo..." com delay de 3 segundos
            setTimeout(() => {
              addMessage('Respondendo...', 'bot', 'wait_' + data[0].id);
            }, 3000);
          }
        } finally {
          // Não habilita o botão aqui, só quando receber resposta
        }
      });

      // Realtime: escuta novas respostas para este usuário
      supabase
        .channel('conversas-updates')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'conversas' }, payload => {
          const msg = payload.new;
          // Substitui o balão de respondendo pela resposta
          const waitDiv = messagesDiv.querySelector('[data-msgid="wait_' + msg.id + '"]');
          if (waitDiv && msg.resposta) {
            waitDiv.textContent = msg.resposta;
            waitDiv.dataset.msgid = msg.id;
            waitDiv.className = 'msg bot';
          } else if (msg.resposta) {
            addMessage(msg.resposta, 'bot', msg.id);
          } else if (waitDiv) {
            // Se não tem resposta, só remove o balão
            waitDiv.remove();
          }
          // Quando uma resposta chega, verifica se ainda há mensagem sem resposta
          loadMessages();
        })
        .subscribe();

      // Carrega mensagens ao abrir
      loadMessages();
    });
  </script>
</body>
</html>
